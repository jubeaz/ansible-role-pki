---
- name: List all the csr to sign
  find:
    path: "{{ _ca_dirs['_ca_csr']['path'] }}"
    pattern: "*.{{ _ca_csr_ext }}"
  register: __csr_list

- name: Set csr_list
  set_fact:
    csr_list: "{{ csr_list }} + [ '{{ item.path | basename }}']"
  with_items: "{{ __csr_list.files }}"

- name: Sign csrs
  command:
    argv:
      - openssl
      - ca
      - -batch
      - -passin
      - "pass:{{ ca_root_cert_info['password'] }}"
      - -config
      - "{{ _ca_dirs['_ca_cnf'].path }}/ca-intermediate.cnf"
      - -in
      - "{{ _ca_dirs['_ca_csr'].path }}/{{ item }}"
      - -out
      - "{{ _ca_dirs['_ca_new_certs'].path }}/{{ item |splitext | first }}.{{ _ca_cert_ext }}"
  with_items: "{{ csr_list }}"
  when: (csr_list | length) > 0

- name: read certificates for bundle files creation
  command: awk 1 "{{ _ca_dirs['_ca_new_certs'].path }}/{{ item |splitext | first }}.{{ _ca_cert_ext }}" "{{ _ca_dirs['_ca_certs'].path }}/{{ _ca_cert_name }}"
  register: ca_bundle
  with_items: "{{ csr_list }}"

- name: create bundle files
  copy:
    dest: "{{ _ca_dirs['_ca_new_certs'].path }}/bundle-{{ item.cmd[2] |basename }}"
    content: "{{ item.stdout }}"
    remote_src: true
  with_items: "{{ ca_bundle.results }}"

- name: Copy csrs to signed_csr
  copy:
    src: "{{ _ca_dirs['_ca_csr'].path }}/{{ item }}"
    dest: "{{ _ca_dirs['_ca_signed_csr'].path }}"
    owner: root
    group: root
    mode: 0644
    remote_src: true
  with_items: "{{ csr_list }}"

- name: Delete csr
  file:
    path: "{{ _ca_dirs['_ca_csr'].path }}/{{ item }}"
    state: absent
  with_items: "{{ csr_list }}"
