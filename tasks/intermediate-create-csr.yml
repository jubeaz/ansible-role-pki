---
- name: Check if intermediate certificate file exist
  stat:
    path: "{{ _ca_dirs['_ca_certs'].path }}/{{ _ca_cert_name }}"
  register: __ca_cert_file

- name: Create intermediate csr
  command:
    argv:
      - openssl
      - req
      - -config
      - "{{ _ca_dirs['_ca_cnf'].path }}/req-intermediate.cnf"
      - -new
      - -out
      - "{{ _ca_dirs['_ca_private'].path }}/{{ _ca_csr_name }}"
  when: not __ca_cert_file.stat.exists

- name: Get csr on controller node
  fetch:
    src: "{{ _ca_dirs['_ca_private'].path }}/{{ _ca_csr_name }}"
    dest: "{{ _pki_transfert_d['_csr_d']['path'] }}/"
    owner: root
    group: root
    mode: 0644
    flat: true
  when: not __ca_cert_file.stat.exists
